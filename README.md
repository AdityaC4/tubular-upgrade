# Tubular WebAssembly Compiler

Tubular is a didactic compiler for a small “Tube” language that emits WebAssembly
Text (WAT). The first version was built for CSE 450 (Compilers); the current
repository extends it with optimization passes, configurable pass ordering, and a
reproducible data-collection pipeline used to study pass-order sensitivity.

[report link](https://adityac4.github.io/pass_order_study.pdf)

## Language Support

- Complete type system with int, double, char, string types
- Control flow: if/else, while loops, break/continue statements
- First-class functions with recursion support
- String operations: concatenation, repetition, indexing
- Type casting with implicit and explicit conversions

## Optimization Passes

1. **Function Inlining** – Pure/small functions are cloned into call sites.
2. **Loop Unrolling** – Affine `while` loops with literal bounds can be unrolled; `--unroll-factor=N` controls the stride.
3. **Tail Recursion Elimination** – Tail-recursive calls can be converted into explicit loops via a dedicated AST node.

Any permutation of the three passes can be selected via
`--pass-order=inline,unroll,tail` (or any ordering of the tokens).

## Architecture

The compiler follows a traditional three-phase design with modern C++ implementation:

```
Source (.tube) → Frontend → Middle-end → Backend → WebAssembly (.wat/.wasm)
```

- **Frontend**: Lexical analysis, parsing, AST construction
- **Middle-end**: Optimization passes and program analysis
- **Backend**: WebAssembly code generation

## Quick Start

### Prerequisites

```bash
sudo apt install wabt

wget https://github.com/bytecodealliance/wasmtime/releases/latest/download/wasmtime-*-linux.tar.xz
tar xf wasmtime-*-linux.tar.xz && sudo cp wasmtime-*/wasmtime /usr/local/bin/
```

### Building

```bash
./make              # Build the compiler
./make test         # Run complete test suite
./make clean        # Clean generated files
```

### Basic Usage

```bash
# Basic compilation
./build/Tubular program.tube             # Generate program.wat
wat2wasm program.wat                     # Generate program.wasm
wasmtime program.wasm                    # Execute

# With optimizations
./build/Tubular program.tube --unroll-factor=8 --no-inline --tail=loop
```

### Exploring Pass Ordering

```
./build/Tubular program.tube --pass-order=inline,tail,unroll
```

Any permutation of `inline`, `unroll`, and `tail` is accepted. Additional flags
such as `--no-inline`, `--unroll-factor=N`, and `--tail=off` can be combined.

## Research Data Collection

The repository includes a reproducible pipeline for measuring pass-order
sensitivity on a suite of ten curated benchmarks (`research_tests/`). To capture
the full dataset used in the accompanying technical report:

```bash
./scripts/collect_data.py
```

This command:

1. Rebuilds the compiler.
2. Runs the legacy regression suite (`./make test`) for sanity.
3. Executes every benchmark × optimization variant × pass-order permutation with
   warm-ups and 50 timed runs, writing results to `artifacts/research/`.

To repeat the sweep multiple times (for example, three batches to check
stability):

```bash
./scripts/repeat_collection.py --runs 3
```

Aggregated CSV/JSON summaries are written to `docs/figures/` and
`artifacts/research/`. Helper scripts such as
`scripts/analyze_research_data.py` and
`scripts/generate_benchmark_features_table.py` generate the tables that appear
in the technical report.

## Documentation

- **[SPECS.md](SPECS.md)** – Tube language specification.
- **[TESTING.md](TESTING.md)** – Legacy regression tests and harnesses.
- **[docs/PROJECT_OVERVIEW.md](docs/PROJECT_OVERVIEW.md)** – Architectural summary.
- **[docs/DATA_PIPELINE.md](docs/DATA_PIPELINE.md)** – Data collection workflow and reproducibility notes.

## Repository Layout (Highlights)

- `Tubular.cpp` – Driver that wires together parsing, passes, and code generation.
- `src/frontend/` – Lexer, AST nodes, and visitor interface.
- `src/middle_end/` – Control, symbol table, pass infrastructure, and optimization passes.
- `research_tests/` – Benchmark suite used in the pass-order study.
- `scripts/` – Automation helpers for builds, data collection, and analysis.
- `artifacts/research/` – Raw and aggregated datasets (regenerated by the scripts).
